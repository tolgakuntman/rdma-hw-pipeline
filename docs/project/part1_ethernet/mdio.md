## MDIO Management Interface

The **MDIO (Management Data Input/Output)** interface is used by the AXI 1G/2.5G Ethernet Subsystem to **configure and monitor the external PHY** (DP83867 on the KR260) over a low-speed serial bus defined by IEEE 802.3 (Clause 22 / Clause 45).

At a high level:

- The **MAC** contains an **MDIO controller**.
- Software (running on the PS) talks to the MAC via **`s_axi_lite`**.
- The MAC’s MDIO controller then generates **MDC** and **MDIO** transactions towards the **DP83867 PHY**.
- All PHY configuration (speed/duplex/auto-negotiation, RGMII delays, loopback, status reads, etc.) goes through this path.

---

### 1. MDIO Signals and Direction

On the AXI Ethernet Subsystem, the MDIO interface typically appears as the following ports:

- **`mdc`**  
  - Output from the MAC to the PHY.  
  - Serial **clock** generated by the internal MDIO controller.  
  - Driven at a relatively low frequency (usually ≤ **2.5 MHz**, as required by the PHY and IEEE 802.3).

- **`mdio_i` / `mdio_o` / `mdio_t`** (or a combined bidirectional `mdio` port, depending on IP configuration)  
  - **`mdio_o`**: Output from the MAC to the PHY (during write operations or PHY address / register selection).  
  - **`mdio_i`**: Input from the PHY to the MAC (during read operations and status responses).  
  - **`mdio_t`**: Tri-state control for the MDIO line (controls when the MAC releases the line so the PHY can drive it).  
  - On the board, these signals are tied together and connected to the PHY’s **MDIO** pin through a **pull-up resistor** (open-drain / open-collector style bus).

On the **KR260 + DP83867**:

- `mdc` → routed to the DP83867 **MDC** pin.
- `mdio` (via `mdio_o`/`mdio_i`/`mdio_t`) → routed to the DP83867 **MDIO** pin.
- The I/O bank and voltage standard must match the PHY’s MDIO voltage (typically 1.8 V or 3.3 V, depending on the board design).
- A pull-up resistor on **MDIO** is required (often provided on the carrier board).

---

### 2. Relationship Between MDIO, MDC, and `s_axi_lite_clk`

The **MDC clock is derived from `s_axi_lite_clk`**, not from the data-plane clocks (`axis_clk` / `gtx_clk`):

- The AXI Ethernet Subsystem contains a small MDIO clock divider.
- It divides **`s_axi_lite_clk`** down to produce the **MDC** signal.
- A typical formula (conceptually) is:

  \[
  f_{\text{MDC}} = \frac{f_{\text{s\_axi\_lite\_clk}}}{2 \times (1 + \text{MDIO\_DIV})}
  \]

- The MDIO controller ensures that **`f_MDC`** does **not exceed the PHY’s maximum**, usually **2.5 MHz**.

In the **KR260 design**:

- `s_axi_lite_clk` is usually **100 MHz** (derived from `pl_clk0` coming from the PS).
- The MAC driver (in Vitis) programs the MDIO clock divider so that:
  - MDC stays ≤ 2.5 MHz.
  - The PHY is always accessed with a safe, compliant clock.
- As long as `s_axi_lite_clk` is stable and the MDIO divider is properly configured, **MDC timing is guaranteed** by the IP and you do not need a separate clocking wizard for MDIO.

---

### 3. MDIO Protocol Basics (Clause 22)

The MDIO bus follows the **IEEE 802.3 Clause 22** frame format (for standard 10/100/1000BASE-T PHYs like DP83867). Each MDIO transaction consists of:

1. **Preamble**  
   - 32 bits of `1` (optional for some PHYs, but the MAC usually sends it).  
   - Used to synchronize the PHY’s MDIO state machine.

2. **Start of Frame (ST)**  
   - 2-bit start code (usually `01`).

3. **Operation Code (OP)**  
   - `01` → **Write** operation.  
   - `10` → **Read** operation.

4. **PHY Address (PHYAD)**  
   - 5-bit address (0–31) of the target PHY.  
   - Must match the **strap-configured** address of the DP83867 on the KR260 (often `0x01`, but depends on board straps).

5. **Register Address (REGAD)**  
   - 5-bit address (0–31) of the target register within that PHY.  
   - Example: Basic Control Register, Basic Status Register, PHY-specific control/status registers, RGMII delay config, etc.

6. **Turnaround (TA)**  
   - 2 bits where the bus master (MAC) releases the MDIO line for a read, or drives it for a write.

7. **Data (DATA[15:0])**  
   - 16-bit payload, written to or read from the PHY register.  
   - All PHY configuration is done by writing appropriate bitfields into these registers.

All of this is handled **inside the AXI Ethernet Subsystem**. From software’s perspective, you simply call the appropriate driver functions to **read/write a 16-bit PHY register**, and the IP generates the MDIO waveforms automatically.

---

### 4. Software View: Using MDIO via `s_axi_lite`

From software (running on the PS, typically on an A53 core), you never toggle MDIO or MDC directly. Instead, you:

1. Access the MAC’s **control registers** over `s_axi_lite`.
2. Trigger MDIO read/write operations using the Xilinx **AXI Ethernet driver**.
3. The driver programs:
   - The PHY address.
   - The register address.
   - The data (for writes).
   - The MDIO control bits (start operation, read vs write).
4. The MDIO controller then:
   - Generates the MDC clock.
   - Drives MDIO (for writes).
   - Samples MDIO (for reads).
   - Updates a status bit when the transaction completes.

Typical functions in the **XAxiEthernet** driver (names may vary slightly by SDK version):

- `XAxiEthernet_PhyRead()`  
  - Reads a 16-bit register from the PHY via MDIO.

- `XAxiEthernet_PhyWrite()`  
  - Writes a 16-bit value to a PHY register via MDIO.

- Higher-level functions (e.g. in the PHY driver layer) build on top of these to:
  - Configure **auto-negotiation**.
  - Set **speed** (10/100/1000 Mbps).
  - Configure **duplex mode**.
  - Enable **RGMII internal delays**.
  - Read **link status**, partner capabilities, and error flags.

Thus, **all PHY configuration is indirect**:
> PS software → `s_axi_lite` → MAC MDIO controller → MDC/MDIO → DP83867 PHY.

---

### 5. MDIO in the KR260 + DP83867 Design

In the context of this KR260 project:

- The **AXI Ethernet Subsystem** is instantiated in the PL and connected to:
  - `s_axi_lite_clk` and `s_axi_lite_*` from the PS (for configuration and MDIO control).
  - RGMII data pins to/from the **DP83867**.
  - MDIO pins to/from the **DP83867**.
- During system initialization, the software running on the PS:
  1. Initializes the AXI Ethernet Subsystem over `s_axi_lite`.
  2. Sets up the MDIO clock divider so that `f_MDC` is safe (≤ 2.5 MHz).
  3. Probes the PHY via MDIO (e.g. read PHY ID registers).
  4. Configures link parameters (RGMII mode, internal delay, auto-negotiation, etc.).
  5. Waits for link up and reads status through MDIO.

From the block design perspective:

- **No extra clocking circuitry** is required specifically for MDIO; it relies on `s_axi_lite_clk`.
- You must **expose** the `mdc` and `mdio` ports at the top level and connect them to the correct SOM / carrier board pins that route to the **DP83867**.
- The external pull-up and voltage levels are handled by the board design.

---

### 6. Summary

- **MDIO** is the **management bus** between the AXI Ethernet Subsystem (MAC) and the **DP83867 PHY**.
- **MDC** is a low-frequency clock generated from **`s_axi_lite_clk`** using an internal divider.
- All **PHY configuration and status reads** (speed, duplex, auto-negotiation, RGMII delays, link status) are done via MDIO transactions.
- Software accesses MDIO **indirectly** through the MAC’s `s_axi_lite` registers and the Xilinx AXI Ethernet driver.
- In the KR260 design, once MDIO is wired and configured correctly, the PS can fully control and monitor the external PHY entirely over this interface, without touching the RGMII data path or data-plane clocks.

