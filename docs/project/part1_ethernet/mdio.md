## MDIO Management Interface

The **MDIO (Management Data Input/Output)** interface is used by the AXI 1G/2.5G Ethernet Subsystem to **configure and monitor the external PHY** (DP83867 on the KR260) over a low-speed serial bus. It is a Bi-directional management instruction/data signal that is sourced by the management station or the PHY during portions of communication. This interface is present in MII, GMII, RGMII and SGMII modes.

The Management Data Input/Output (MDIO) component can be used to read and write the PHY control register. Each PHY can be monitored before operation and the connection status can be monitored during operation. These registers provide status and control information such as link status, speed ability, and selection, power down for low power consumption, duplex mode (full or half), auto-negotiation, fault signaling, and loopback. 

![mdio](images/mdio.png)


![mdio](images/mdio_ports.png)


| Port | Description |
|------|-------------|
| `mdio_mdc` | MDIO clock |
| `mdio_mdio_i` | PHY → MAC |
| `mdio_mdio_o` | MAC → PHY |
| `mdio_mdio_t` | Tristate enable |

At a high level:

- The **MAC** contains an **MDIO controller**.
- Software (running on the PS) talks to the MAC via **`s_axi`** port we have on PL ethernet block.
- The MAC’s MDIO controller then generates **MDC** and **MDIO** transactions towards the **DP83867 PHY**.
- All PHY configuration (speed/duplex/auto-negotiation, RGMII delays, loopback, status reads, etc.) goes through this path.

---

### 1. MDIO Signals and Direction

On the AXI Ethernet Subsystem, the MDIO interface typically appears as the following ports:

- #### **mdio_mdc**  
   - Output from the MAC to the PHY.  
   - Serial **clock** generated by the internal MDIO controller.  

- #### **mdio_i / mdio_o / mdio_t** 
  - **`mdio_o`**: Output from the MAC to the PHY (during write operations or PHY address).  
  - **`mdio_i`**: Input from the PHY to the MAC (during read operations and status responses).  
  - **`mdio_t`**: Tri-state control for the MDIO line (controls when the MAC releases the line so the PHY can drive it).  

 In a write instruction, the MAC provides the address and data. For a read instruction, the PHY receives from the MDIO stream during the turnaround, supplies the MAC with the requested register data, and then releases the MDIO stream.
---

### 2. MDIO Protocol Frame Format (CLAUSE 22):

![clause22](images/mdio_clause22.png)
The MDIO data format for clause 22 is defined in the IEEE 802.3 Ethernet standard, as shown in the figure above.


Since there is a limit to using only 5-bit addresses for both PHYADDR and REGADDR, MDIO supports up to 32 PHYs. Kr260 has 4 PHY addresses and our GEM 2 PL ethernet port PHY address is 2.

**Data (DATA[15:0])**  
   - This field is 16-bit wide. During the read instruction, the PHY chip writes the data read from the REGAD register corresponding to the PHYAD in Data. During the write instruction, the MAC writes the value of the REGAD register corresponding to the PHYAD in Data. 
   - All PHY configuration is done by writing appropriate bitfields into these registers.

All of this is handled **inside the AXI Ethernet Subsystem**. From software’s perspective, you simply call the appropriate driver functions to **read/write a 16-bit PHY register**, and the IP generates the MDIO waveforms automatically. So I used multiple read and writes to configure the phy or see the status of the connection from vitis. I will explain them in the next part. 

---

### 3. Software  from Vitis: Using MDIO via `s_axi` on PL ethernet IP

This part explains **every place where MDIO is used** in the vitis code and how each piece relates to configuring and monitoring the external PHY via the AXI Ethernet MDIO controller.

In vitis, all MDIO access is done through the functions:
- `XAxiEthernet_PhyRead()`
- `XAxiEthernet_PhyWrite()`

These functions talk to the **MAC’s MDIO block** using AXI-Lite; the MAC then drives
the **MDC/MDIO** pins toward the external PHY.


### 3.1 MDIO-Related Constants (PHY address, registers, and bits)

```c
/* PHY address used on the KR260 board for GEM2 PL ethernet*/
#define PHY_ADDR_CONFIG     2   //important

/* PHY register addresses (written in DP83867IR PHY datasheet)*/
#define PHY_REG_BMCR   0
#define PHY_REG_BMSR   1

/* BMCR bits (Basic Mode Control Register) */
#define BMCR_AUTONEG_EN  0x1000   //enable auto negotiation bit 12
#define BMCR_RESTART_AN  0x0200   //restart auto negotiation bit 9 

/* BMSR bits (Basic Mode Status Register) */
#define BMSR_LINK_STATUS  0x0004  //link status bit 2
```









- `XAxiEthernet_PhyRead()`  
  - Reads a 16-bit register from the PHY via MDIO.
 
- `XAxiEthernet_PhyWrite()`  
  - Writes a 16-bit value to a PHY register via MDIO.

- Higher-level functions (e.g. in the PHY driver layer) build on top of these to:
  - Configure **auto-negotiation**.
  - Set **speed** (10/100/1000 Mbps).
  - Configure **duplex mode**.
  - Enable **RGMII internal delays**.
  - Read **link status**, partner capabilities, and error flags.

Thus, **all PHY configuration is indirect**:
> PS software → `s_axi_lite` → MAC MDIO controller → MDC/MDIO → DP83867 PHY.

---

### 4. MDIO in the KR260 + DP83867 Design

In the context of this KR260 project:

- The **AXI Ethernet Subsystem** is instantiated in the PL and connected to:
  - `s_axi_lite_clk` and `s_axi_lite_*` from the PS (for configuration and MDIO control).
  - RGMII data pins to/from the **DP83867**.
  - MDIO pins to/from the **DP83867**.
- During system initialization, the software running on the PS:
  1. Initializes the AXI Ethernet Subsystem over `s_axi_lite`.
  2. Sets up the MDIO clock divider so that `f_MDC` is safe (≤ 2.5 MHz).
  3. Probes the PHY via MDIO (e.g. read PHY ID registers).
  4. Configures link parameters (RGMII mode, internal delay, auto-negotiation, etc.).
  5. Waits for link up and reads status through MDIO.

From the block design perspective:

- **No extra clocking circuitry** is required specifically for MDIO; it relies on `s_axi_lite_clk`.
- You must **expose** the `mdc` and `mdio` ports at the top level and connect them to the correct SOM / carrier board pins that route to the **DP83867**.
- The external pull-up and voltage levels are handled by the board design.

---

### 5. Summary

- All **PHY configuration and status reads** (speed, duplex, auto-negotiation, RGMII delays, link status) are done via MDIO transactions.
- In the KR260 design, once MDIO is wired and configured correctly, the PS can fully control and monitor the external PHY entirely over this interface, without touching the RGMII data path or data-plane clocks.

