# Timing & Clocks

This chapter explains how clocks and resets are organized in **Part 1 – PL Ethernet** on the KR260, and why the exact frequencies matter for the **AXI 1G/2.5G Ethernet Subsystem, RGMII I/O, and our custom RX/TX logic**.

We focus on:

- Which clock each IP core uses.
- How we generate 125 MHz and 300 MHz from the 25 MHz board clock.
- How the PS 100 MHz clock is used for AXI-Lite control.
- How reset domains are separated.
- Practical timing / bring-up notes we discovered while debugging.

---

## 1. Board-Level Clocks on KR260

On the KR260 carrier card we rely on two main clock sources:

- **25 MHz PL reference clock**  
   - Comes from the SOM connector (som240_1_connector_hpa_clk0p_clk) into the PL.  
   - In the block design it is wired to the input of a **Clocking Wizard** (MMCM/PLL).  
   - Used only as a *source*; we never run logic directly at 25 MHz.

- **100 MHz PS → PL clock (`pl_clk0`)**  
   - Generated by the Zynq UltraScale+ MPSoC PS.  
   - Exported into the PL through the **PS block** (`zynq_ultra_ps_e`).  
   - Used as the **AXI-Lite and “system” clock** for all ip blocks.

![Clocking Wizard](images/clocking_wizard.png)


Since AXI 1G/2.5G Ethernet ip block needs an exact 125 Mhz input clock for gtx_clk, this clock in the PL are derived from the 25 MHz board clock input via the Clocking Wizard.

---

## 2. PL Clock Architecture in Part 1

At the heart of the PL clocking is a **Clocking Wizard IP** with:

| Signal                 | Description                             |
|------------------------|-----------------------------------------|
| `clk_in1` (25 MHz)     | Board reference clock                   |
| `clk_out1` (125 MHz)   | Ethernet data-plane / RGMII clock       |
| `clk_out2` (200 MHz)   | IDELAY reference clock                  |

These outputs feed three separate clock domains:

1. **100 MHz domain** – PS control & AXI-Lite.  
2. **125 MHz domain** – Ethernet MAC data-plane and our custom TX/RX logic.  
3. **200 MHz domain** – IDELAY controller calibration.

Each domain has its **own `proc_sys_reset`** to generate clean, synchronous resets.

> **NOTE (diagram):** Add a small timing / block diagram with three branches labelled “100 / 125 / 200 MHz + proc_sys_reset”.

---

## 3. 100 MHz Control / AXI-Lite Domain

The 100 MHz domain is driven directly from **`pl_clk0`** of the PS.

Components clocked at 100 MHz:

- `ps8_0_axi_periph` (AXI interconnect for control)
- AXI-Lite interfaces of:
  - `axi_ethernet_0` (MAC control/status)
  - `axi_bram_ctrl_0` (if used for configuration)
- `proc_sys_reset_100M`

We deliberately keep:

- **All AXI-Lite slaves** on the same 100 MHz clock.  
- No custom logic in this domain other than standard AMD IP.

This simplifies timing closure and ensures that **Vitis drivers and AXI-Lite access timings** match the expected 100 MHz environment.

---

## 4. 125 MHz Ethernet Data-Plane Domain

The **125 MHz clock** (`clk_out1` from the Clocking Wizard) is the **core data-plane clock** for Ethernet:

Clocked at 125 MHz:

- `axi_ethernet_0` data-plane ports:  
  - `axis_clk`  
  - `gtx_clk` / `tx_clk_out` (internally)  
  - `ref_clk` (RGMII reference)
- RGMII I/O logic inside the MAC (TXD/RXD DDR registers).
- `eth_axis_patgen_0` (our Ethernet pattern generator).
- `axis_rx_to_bram_0` (our RX buffering + forwarder module).
- Any future RDMA RX-side modules that sit directly behind the MAC.

Reset for this domain is produced by **`proc_sys_reset_125M`**, whose `slowest_sync_clk` is the 125 MHz clock and whose `ext_reset_in` is driven from the PS reset output.

### 4.1 Why 125 MHz is Mandatory

The AXI 1G/2.5G Ethernet Subsystem **requires** a 125 MHz clock when configured for **RGMII**:

- At **1 Gbps**, RGMII uses 125 MHz DDR (Rising = low nibble, Falling = high nibble).
- At **100 / 10 Mbps**, the PHY still uses 125 MHz on the RGMII side and internally rate-adapts the line speed.

We initially found it confusing that:

- The PHY may negotiate 100 Mbps on the copper link,  
- But the MAC still insists on **125 MHz** on its `gtx_clk/ref_clk`.

If `clk_out1` were set to 100 MHz by mistake, the MAC would:

- Fail timing internally.  
- Potentially never assert `m_axis_rxd_tvalid`.  
- Produce sporadic RX/TX errors even if link LEDs look fine.

Setting **exactly 125.000 MHz** in the Clocking Wizard is therefore non-negotiable.

> **NOTE (screenshot):** Add Clocking Wizard config page showing `clk_out1 = 125 MHz` and “Use as global buffer”.

### 4.2 Single-Clock Data Path Design

To avoid any clock-domain crossing issues in Part 1:

- All custom data-plane modules (`eth_axis_patgen`, `axis_rx_to_bram`, later RDMA RX blocks) use the **same `axis_clk` = 125 MHz**.
- We **do not** introduce extra clock domains in the Ethernet RX/TX pipeline.

This design choice is important because:

- The only handshake between modules is **AXI-Stream** (valid/ready).  
- Keeping them on the same clock eliminates CDC synchronizers and simplifies debugging:
  - If `tvalid` is 1 and `tready` is 0, we just **hold data stable** until the handshake completes.
  - All our “lost word” bugs turned out to be **handshake logic issues**, not clock domain issues.

---

## 5. 200 MHz IDELAY / I/O Calibration Domain

RGMII I/O timing depends on properly calibrated **IDELAY / ODELAY** elements in the I/O banks.  
On UltraScale+ devices, these are controlled by a **`util_idelay_ctrl`** block that requires a **200 MHz reference clock**.

In our design:

- `clk_out2` from the Clocking Wizard is set to **200 MHz**.
- This clock drives:
  - `util_idelay_ctrl_0` (or the IDelay controller embedded in the AXI Ethernet IP)
  - `proc_sys_reset_200M`

Why 200 MHz?

- AMD documentation recommends **200 MHz** as the most robust frequency for IDELAY calibration.
- Vivado issues warnings if the IDELAY controller is not fed with the correct frequency, or if the clock is missing.

> **NOTE (screenshot):** Add screenshot of Clocking Wizard with `clk_out2 = 200 MHz`, and the IDELAY controller schematic view.

Without a valid 200 MHz clock:

- RGMII timing is undefined.  
- You may see link-up but corrupted frames / random CRC errors.  
- Vivado timing report often shows “IDELAYCTRL not calibrated” warnings.

---

## 6. Reset Strategy and Domain Separation

We use **three `proc_sys_reset` instances**, one per clock domain:

| Reset Block           | Clock Input    | Drives Resets For                                            |
|-----------------------|----------------|--------------------------------------------------------------|
| `proc_sys_reset_100M` | 100 MHz (pl_clk0) | AXI-Lite interconnect, MAC AXI-Lite port, control logic |
| `proc_sys_reset_125M` | 125 MHz        | AXI Ethernet data-plane, custom TX/RX modules               |
| `proc_sys_reset_200M` | 200 MHz        | IDELAY controller / 200 MHz peripherals                      |

Common inputs:

- `ext_reset_in` ← PS system reset output.  
- `dcm_locked`/`pll_locked` signals from the Clocking Wizard where appropriate.

**Why separate resets?**

- Each clock domain must release reset **only after its own clock is stable**.  
- If we used a single reset block, the 200 MHz domain might de-assert reset before the MMCM has locked, leading to IDELAY mis-calibration.
- With independent blocks:
  - The 125 MHz Ethernet logic starts only after `clk_out1` is locked.
  - The 200 MHz IDELAY logic starts only after `clk_out2` is locked.

> **NOTE (screenshot):** Add a zoomed-in screenshot showing the three `proc_sys_reset` blocks and their clock connections.

---

## 7. RGMII & Clock Ports on AXI Ethernet

The AXI 1G/2.5G Ethernet Subsystem exposes several clock-related ports in RGMII mode:

- `ref_clk` – 125 MHz reference used for RGMII I/O logic.
- `axis_clk` – 125 MHz clock for AXI-Stream TX/RX interfaces.
- `s_axi_lite_clk` – 100 MHz AXI-Lite clock.
- `phy_rst_n` – reset output to the PHY (synchronous to 125 MHz domain).

Our connections:

- `ref_clk`   ← 125 MHz (clk_out1)
- `axis_clk`  ← 125 MHz (same net as `ref_clk`)
- `s_axi_lite_clk` ← 100 MHz (pl_clk0)
- `phy_rst_n` ← de-asserted by logic inside the MAC but ultimately controlled by `proc_sys_reset_125M`.

A few things we learned while wiring this:

1. **Do not** tie `ref_clk` to 100 MHz – Vivado will allow it, but the MAC behaviour becomes undefined.
2. Keep **`ref_clk` and `axis_clk` identical** in this design; separating them adds complexity without benefit.
3. Ensure `phy_rst_n` only de-asserts after:
   - 125 MHz clock is stable.
   - IDELAY controller has locked (for clean RGMII timing).

---

## 8. Timing Closure and Warnings

With the clocking scheme above, **Post-Implementation Timing** for Part 1 closes comfortably at 125 MHz.

However, there are a few *expected* (non-fatal) messages:

- IDELAY / MMCM related notes (e.g. “IDELAYCTRL frequency assumed 200 MHz”).  
- RGMII I/O timing info messages referencing external delays.

Key checks before trusting the bitstream:

1. **`Report Timing Summary` → Worst Negative Slack (WNS) ≥ 0**  
   - Especially for the **125 MHz** and **200 MHz** clocks.

2. **Check for “IDELAYCTRL not calibrated” warnings**  
   - If present, verify `util_idelay_ctrl` really sees the 200 MHz clock.

3. **External I/O timing**  
   - For KR260, the board part already adds correct constraints for RGMII pins.  
   - We do not need custom XDC constraints for RGMII in Part 1.

If WNS is slightly negative on the 200 MHz domain but everything else is green, carefully analyze which paths are failing; in our design the hot path is entirely inside the Ethernet + IDELAY; typically it still passes at 200 MHz with some margin.

---

## 9. Practical Debugging Tips Related to Clocks

When something goes wrong on the KR260 Ethernet link, check clocks first:

1. **Is `ref_clk` really 125 MHz?**  
   - Confirm Clocking Wizard output frequency.  
   - Probe on an ILA or scope if exported.

2. **Are all three `proc_sys_reset` outputs de-asserted?**  
   - If 200 MHz reset stays asserted, IDELAY will never calibrate.

3. **Is `pl_clk0` set to 100 MHz in the PS configuration?**  
   - AXI-Lite transactions may misbehave if the actual clock differs from what drivers expect.

4. **Do pattern-generator packets look correct in Wireshark but custom RX misses beats?**  
   - If yes, clocking is probably fine and the problem is handshake / logic, not timing.

5. **Random CRC errors only at 1 Gbps, but 100 Mbps seems OK?**  
   - Suspect **RGMII timing / IDELAY / ref_clk** rather than protocol bugs.

---

## 10. Summary

- All PL clocks in Part 1 derive from a **25 MHz board reference** via a **Clocking Wizard**.
- We use **three domains**:
  - 100 MHz (PS / AXI-Lite control)
  - 125 MHz (Ethernet data-plane & RGMII)
  - 200 MHz (IDELAY controller)
- Each domain has its **own `proc_sys_reset`**.
- The **AXI Ethernet Subsystem** expects:
  - 125 MHz on `ref_clk` and `axis_clk`.
  - 100 MHz on `s_axi_lite_clk`.
- RGMII always runs with a **125 MHz clock**, independent of 10/100/1000 Mbps line speed.
- IDELAY calibration at **200 MHz** is essential for reliable RGMII timing.

With this clocking and reset structure in place, the KR260 PL Ethernet path becomes a stable foundation for:

- The **TX tests** with `eth_axis_patgen`.
- The **RX path** into BRAM and RDMA decapsulation logic.
- Future expansion (e.g., AXI DMA) without reworking the basic clock tree.

